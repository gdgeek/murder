# 插件与扩展组件

本文档包含插件系统和扩展服务的组件接口定义：PluginSystem、AssetStorage、TagSystem、InterviewService、AI多媒体生成服务、TTS语音服务。

---

## 21. 插件系统 (PluginSystem)

可扩展的插件架构，支持通过配置文件注册不同类型的AI生成服务和云存储服务。

```typescript
// 插件类型
enum PluginType {
  STORAGE = 'storage',         // 存储插件（本地/腾讯COS/AWS S3）
  IMAGE_GEN = 'image_gen',     // 图片生成插件
  MUSIC_GEN = 'music_gen',     // 音乐生成插件
  VIDEO_GEN = 'video_gen',     // 视频生成插件
  TTS_GEN = 'tts_gen'          // TTS语音插件
}

// 插件基础接口
interface IPlugin {
  name: string;
  type: PluginType;
  version: string;
  initialize(config: Record<string, unknown>): Promise<void>;
  destroy(): Promise<void>;
  isHealthy(): Promise<boolean>;
}

// 插件注册表配置（plugins.json）
interface PluginConfig {
  plugins: {
    name: string;
    type: PluginType;
    enabled: boolean;
    module: string;            // 模块路径
    config: Record<string, unknown>;
  }[];
}

// 插件管理器
interface IPluginManager {
  loadPlugins(config: PluginConfig): Promise<void>;
  getPlugin<T extends IPlugin>(type: PluginType): T | null;
  getEnabledPlugins(): IPlugin[];
  isPluginEnabled(type: PluginType): boolean;
}
```

---

## 22. 资源存储服务 (AssetStorage)

统一的资源存取抽象层，默认本地存储，可通过插件切换到云存储。

```typescript
// 资源类型
enum AssetType {
  IMAGE = 'image',
  VIDEO = 'video',
  AUDIO = 'audio',             // 音乐/音效
  TTS_AUDIO = 'tts_audio'      // TTS语音文件
}

// 资源元数据
interface Asset {
  id: string;
  scriptId: string;
  type: AssetType;
  filename: string;
  url: string;                 // 访问URL（本地路径或CDN地址）
  size: number;
  mimeType: string;
  metadata: Record<string, unknown>; // 关联的剧情节点ID等
  createdAt: Date;
}

// 存储插件接口
interface IStoragePlugin extends IPlugin {
  type: PluginType.STORAGE;
  upload(file: Buffer, filename: string, mimeType: string): Promise<string>; // 返回URL
  download(url: string): Promise<Buffer>;
  delete(url: string): Promise<void>;
  getPublicUrl(filename: string): string;
}

// 资源存储服务
interface IAssetStorageService {
  store(scriptId: string, type: AssetType, file: Buffer, filename: string, metadata?: Record<string, unknown>): Promise<Asset>;
  get(assetId: string): Promise<Asset | null>;
  getByScript(scriptId: string, type?: AssetType): Promise<Asset[]>;
  delete(assetId: string): Promise<void>;
}
```

**存储插件实现**：
- `LocalStoragePlugin`：默认，存储到本地 `./uploads/` 目录
- `TencentCOSPlugin`：腾讯云COS，配置 SecretId/SecretKey/Bucket/Region
- 可扩展 AWS S3、阿里云 OSS 等

---

## 23. 标签系统 (TagSystem)

```typescript
// 标签
interface Tag {
  id: string;
  name: string;
  category: TagCategory;       // 标签分类
}

enum TagCategory {
  GAME_TYPE = 'game_type',     // 游戏类型：本格/新本格/变格
  AGE_GROUP = 'age_group',     // 年龄段
  PLAYER_COUNT = 'player_count', // 玩家人数
  ERA = 'era',                 // 时代背景
  THEME = 'theme',             // 主题风格
  CUSTOM = 'custom'            // 用户自定义
}

// 剧本-标签关联
interface ScriptTag {
  scriptId: string;
  tagId: string;
  isAutoGenerated: boolean;    // 系统自动生成 vs 用户手动添加
}

interface ITagService {
  autoGenerateTags(script: Script): Promise<Tag[]>;
  addCustomTag(scriptId: string, tagName: string): Promise<Tag>;
  removeTag(scriptId: string, tagId: string): Promise<void>;
  getScriptTags(scriptId: string): Promise<Tag[]>;
  searchByTags(tagIds: string[], limit: number, offset: number): Promise<Script[]>;
  getPopularTags(limit: number): Promise<Tag[]>;
}
```

**REST API 补充**：
```
标签:
  GET    /api/tags                   - 获取所有标签（支持按category筛选）
  GET    /api/tags/popular           - 热门标签
  POST   /api/scripts/:id/tags      - 为剧本添加自定义标签
  DELETE /api/scripts/:id/tags/:tagId - 移除标签

剧本搜索:
  GET    /api/scripts/search?tags=tag1,tag2&gameType=honkaku&ageGroup=adult
```

---

## 24. AI预生成访谈服务 (InterviewService)

在剧本生成前，AI与创作者进行交互式访谈，通过自适应问答收集创作意图。

```typescript
// 访谈会话
interface InterviewSession {
  id: string;
  configId: string;
  qaHistory: InterviewQA[];
  summary: string | null;
  summaryConfirmed: boolean;
  status: 'in_progress' | 'summarizing' | 'confirmed' | 'cancelled';
  templateId: string | null;       // 使用的访谈模板知识条目ID
  createdAt: Date;
  updatedAt: Date;
}

// 访谈问答对
interface InterviewQA {
  questionIndex: number;
  question: string;
  answer: string;
  dimension: InterviewDimension;   // 该问题覆盖的维度
  answeredAt: Date;
}

// 访谈核心维度
enum InterviewDimension {
  NARRATIVE_STYLE = 'narrative_style',       // 叙事风格偏好
  EMOTIONAL_TONE = 'emotional_tone',         // 情感基调
  DEDUCTION_COMPLEXITY = 'deduction_complexity', // 推理复杂度期望
  CHARACTER_DEPTH = 'character_depth',       // 角色关系深度
  INTERACTION_MODE = 'interaction_mode',     // 玩家互动模式
  SPECIAL_MECHANICS = 'special_mechanics'    // 特殊机制需求
}

// 访谈模板（作为Knowledge_Entry存储）
interface InterviewTemplateContent {
  initialQuestion: string;
  coreDimensions: InterviewDimension[];
  maxQuestions: number;            // 默认10
  summaryPrompt: string;          // 生成摘要的提示词
  fallbackQuestions: string[];     // LLM失败时的备选问题
}

// 访谈服务接口
interface IInterviewService {
  startInterview(configId: string): Promise<InterviewSession>;
  submitAnswer(sessionId: string, answer: string): Promise<{ nextQuestion: string | null; isComplete: boolean }>;
  generateSummary(sessionId: string): Promise<string>;
  confirmSummary(sessionId: string, modifiedSummary?: string): Promise<InterviewSession>;
  cancelInterview(sessionId: string): Promise<void>;
  getSession(sessionId: string): Promise<InterviewSession | null>;
}

// 访谈配置
const INTERVIEW_CONFIG = {
  maxQuestions: 10,
  defaultDimensions: Object.values(InterviewDimension),
  summaryMaxTokens: 1000
};
```

---

## 35. AI多媒体生成服务

```typescript
// 图片生成插件接口
interface IImageGenPlugin extends IPlugin {
  type: PluginType.IMAGE_GEN;
  generateImage(prompt: string, style?: string, size?: string): Promise<Buffer>;
}

// 音乐生成插件接口
interface IMusicGenPlugin extends IPlugin {
  type: PluginType.MUSIC_GEN;
  generateMusic(prompt: string, durationSeconds: number, genre?: string): Promise<Buffer>;
}

// 视频生成插件接口
interface IVideoGenPlugin extends IPlugin {
  type: PluginType.VIDEO_GEN;
  generateVideo(prompt: string, durationSeconds: number): Promise<Buffer>;
}

// 多媒体生成编排服务
interface IMediaGenerationService {
  generateSceneImages(script: Script): Promise<Asset[]>;
  generateCharacterPortraits(script: Script): Promise<Asset[]>;
  generateBackgroundMusic(script: Script): Promise<Asset[]>;
  generateClueCardImages(script: Script): Promise<Asset[]>;
  generateKeySceneVideos(script: Script): Promise<Asset[]>;
  getGenerationStatus(scriptId: string): Promise<MediaGenerationStatus>;
}

interface MediaGenerationStatus {
  scriptId: string;
  images: { total: number; completed: number; failed: number };
  music: { total: number; completed: number; failed: number };
  videos: { total: number; completed: number; failed: number };
}
```

---

## 36. TTS语音服务（实时/预生成双模式）

```typescript
// TTS插件接口
interface ITTSPlugin extends IPlugin {
  type: PluginType.TTS_GEN;
  synthesize(text: string, voice?: string, language?: string): Promise<Buffer>;
  synthesizeStream(text: string, voice?: string, language?: string): AsyncIterable<Buffer>; // 流式实时生成
  estimateLatency(): Promise<number>; // 预估延迟（毫秒）
}

// TTS服务（双模式管理）
interface ITTSService {
  // 预生成模式：剧本生成时为固定文本预生成语音
  preGenerateForScript(script: Script): Promise<Asset[]>;
  
  // 实时模式：游戏中实时生成语音
  speakRealtime(text: string, language?: string): Promise<{ audioUrl: string; latencyMs: number }>;
  
  // 智能模式：优先实时，延迟>2秒回退到预生成
  speak(text: string, scriptId: string, nodeId?: string, language?: string): Promise<{ audioUrl: string; mode: 'realtime' | 'pregenerated' | 'text_fallback' }>;
  
  // 获取预生成的语音资源
  getPreGeneratedAudio(scriptId: string, nodeId: string): Promise<Asset | null>;
}

// 预生成的语音节点类型
enum TTSNodeType {
  OPENING = 'opening',           // 开场白
  ROUND_TRANSITION = 'round_transition', // 轮次过渡
  CLUE_NARRATION = 'clue_narration',     // 线索叙述
  VOTE_PROMPT = 'vote_prompt',           // 投票提示
  BRANCH_NARRATIVE = 'branch_narrative', // 分支叙述
  ENDING_REVEAL = 'ending_reveal',       // 结局揭示
  TRUTH_REVEAL = 'truth_reveal'          // 真相还原
}
```

**TTS双模式工作流**：
1. 剧本生成时：为 DM_Handbook 中所有固定叙述文本预生成 TTS 语音文件，存储到 Asset_Storage
2. 游戏运行时：
   - 固定叙述（开场白、轮次过渡、结局）→ 直接播放预生成语音
   - 动态内容（回答玩家提问、即兴主持）→ 实时 TTS 流式生成
   - 实时生成延迟 > 2秒 → 回退到预生成语音或文字模式
